+function($){function MjaxModel(opts){this.opts=opts,this.modal=$('<div class="modal fade" tabindex="-1" role="dialog" aria-labelledby="mjax"></div>'),this.modalDoc=$('<div class="modal-dialog" role="document"></div>'),this.modalContent=$('<div class="modal-content"></div>'),this.modalHeader=$('<div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>'),this.modalHeaderTitle=$('<h4 class="modal-title">Modal title</h4>'),this.modalBody=$('<div class="modal-body"></div>'),this.modalFooter=$('<div class="modal-footer"><button type="button" class="btn btn-default" data-dismiss="modal">Close</button></div>'),this.modal.append(this.modalDoc),this.modalDoc.append(this.modalContent),this.modalContent.append(this.modalHeader).append(this.modalBody),this.modalHeader.append(this.modalHeaderTitle),this.modalBody.css({padding:"1px 0"})}$.fn.modal&&($.fn.modal.Constructor.prototype.enforceFocus=function(){});var _changed=!1,headers={"X-Mjax-Request":"1.0.1"};MjaxModel.prototype.updateBody=function(){$(".mjax").mjax(this.opts);var _this=this;this.modalBody.find("form").each(function(){var _form=$(this),eventName="submit",opts=_this.opts;if(opts.pointForm?"function"==typeof opts.pointForm?opts.pointForm.call(_form):opts.pointForm:_form.data("point-form")){var pointEvent=opts.pointEvent?opts.pointEvent:_form.data("point-event");pointEvent&&(eventName=pointEvent)}_form.on(eventName,function(event){return event.result=!1,$(this).ajaxSubmit({headers:headers,complete:function(xhr){if(309==xhr.status){var redirect=xhr.getResponseHeader("X-Mjax-Redirect");_this.mjaxGet(redirect,function(response){_this.extractContent(response),_changed=!0})}},success:function(response){_this.extractContent(response),_changed=!0}}),!1})})},MjaxModel.prototype.destroy=function(){this.opts=null,this.modal.remove(),this.modalDoc.remove(),this.modalContent.remove(),this.modalHeader.remove(),this.modalHeaderTitle.remove(),this.modalBody.remove(),this.modalFooter.remove()},MjaxModel.prototype.mjaxGet=function(url,callback){return $.ajax({url:url,type:"get",success:callback,headers:headers})},MjaxModel.prototype.extractContent=function(response){var content=$($.parseHTML(response,document,!0)),scripts=this.findAll(content,"script").remove(),links=this.findAll(content,"link").remove();content=content.not(scripts).not(links),this.modalBody.empty().html(content);var _this=this;$.when(_this.executeTags(links,"link","href",!0),_this.executeTags(scripts,"script","src",!0)).done(function(){_this.updateBody()})},MjaxModel.prototype.findAll=function(elems,selector){return elems.filter(selector).add(elems.find(selector))},MjaxModel.prototype.executeTags=function(tags,tag,attr,reload){if(!tags)return!1;var dtd=$.Deferred(),existingTags=$(tag+"["+attr+"]"),_this=this,cb=function(next){var attribute=this[attr];existingTags.filter(function(){return this[attr]===attribute}).length?next():attribute?(reload&&$.getScript(attribute).done(next).fail(next),document.head.appendChild(this)):(_this.modalBody.append(this),next())},i=0,next=function(){if(i>=tags.length)dtd.resolve();else{var tag=tags[i];i++,cb.call(tag,next)}};return next(),dtd},$.fn.mjax=function(options){var opts=$.extend({},$.fn.mjax.DEFAULTS,options);return this.each(function(){var _this=$(this),_refresh=_this.data("mjax-refresh");"undefined"!=_refresh&&(opts.refresh=_refresh),_this.data("mjax-bind")||(_this.data("mjax-bind",!0),_changed=!1,_this.click(function(e){var instance=new MjaxModel(opts),arch=$(this);e.preventDefault(),_this.attr("title")?instance.modalHeaderTitle.html(_this.attr("title")):instance.modalHeaderTitle.html(_this.html()),instance.mjaxGet(_this.attr("href"),function(response){instance.modal.on("hidden.bs.modal",function(){_changed&&opts.refresh&&window.location.reload(),instance.destroy()}),instance.extractContent(response);var modalSize=arch.data("mjax-size");instance.modalDoc.removeClass("modal-lg").removeClass("modal-sm"),"sm"==modalSize?instance.modalDoc.addClass("modal-sm"):"lg"==modalSize&&instance.modalDoc.addClass("modal-lg"),instance.modal.modal({backdrop:!1})})}))})},$.fn.mjax.DEFAULTS={refresh:!1},$(document).ready(function(){$(".mjax").mjax()})}(jQuery);